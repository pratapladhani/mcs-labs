# =============================================================================
# MICROSOFT COPILOT STUDIO LABS - DOCUMENT GENERATION WORKFLOW
# =============================================================================
# This workflow converts lab markdown files to HTML and PDF formats with:
# - Professional styling and layout
# - Working PDF bookmarks and table of contents
# - Clean internal link handling
# - Consistent branding and navigation
# =============================================================================

name: üìö Generate Lab Documentation (HTML & PDF)

# =============================================================================
# WORKFLOW TRIGGERS
# =============================================================================
on:
  # Trigger on changes to lab content or styling
  push:
    branches:
      - main
      - feature/restructure-generated-files  # Test branch for restructure
    paths:
      - "labs/*/*.md"           # Lab markdown content
      - "labs/*/images/**"      # Lab images and assets
      - ".github/styles/**"     # CSS styling files
      - ".github/workflows/generate-documentation.yml"  # This workflow file
      - ".github/scripts/**"    # PDF generation scripts
      - "package.json"          # Dependencies
  
  # Allow manual execution from GitHub Actions UI
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug output'
        required: false
        default: false
        type: boolean

# =============================================================================
# WORKFLOW JOBS
# =============================================================================
jobs:
  generate-documentation:
    name: üî® Generate Lab Documents
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # =================================================================
      # STEP 1: REPOSITORY SETUP
      # =================================================================
      - name: üìÇ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better git operations

      # =================================================================
      # STEP 2: INSTALL DOCUMENT CONVERSION TOOLS
      # =================================================================
      - name: üìÑ Setup Pandoc (Markdown to HTML Converter)
        uses: pandoc/actions/setup@v1.1.1
        with:
          version: 3.1.3

      - name: üîß Setup Node.js and PDF Generation Tools
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: üìÑ Install Puppeteer for Reliable PDF Generation
        run: |
          echo "üîß Installing Puppeteer for stable HTML to PDF conversion..."
          
          # Install dependencies including Puppeteer for PDF generation
          npm install
          echo "‚úÖ Dependencies installed successfully"
          
          # Install emoji and international fonts for better PDF rendering
          # Note: We use Puppeteer (not LaTeX) for PDF generation, so texlive packages are not needed
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends fonts-noto-color-emoji fonts-noto-sans fonts-noto-serif || echo "‚ö†Ô∏è Warning: Could not install some fonts"
          echo "‚úÖ Font installation completed"

          # Verify tool versions (suppress LaTeX package suggestions since we use Puppeteer for PDFs)
          echo "üîç Verifying installations:"
          pandoc --version 2>/dev/null | head -2 || echo "Pandoc version check failed"
          node --version
          npm list puppeteer --depth=0 2>/dev/null || echo "Puppeteer: $(npm list puppeteer --depth=0 2>&1 | grep puppeteer || echo 'not found globally, but available locally')"
        timeout-minutes: 8

      # =================================================================
      # STEP 3: MARKDOWN TO HTML CONVERSION
      # =================================================================
      # Process each lab's README.md file and convert to styled HTML
      # with proper navigation, clean headers, and web optimization
      # =================================================================
      - name: üåê Convert Lab Markdown to HTML
        run: |
          echo "üåê Starting HTML conversion for all lab directories..."
          
          # Create dist directory structure
          mkdir -p dist
          
          # Process each lab directory containing a README.md file
          for lab_dir in labs/*/; do
            if [ -d "$lab_dir" ] && [ -f "${lab_dir}README.md" ]; then
              lab_name=$(basename "$lab_dir")
              echo "üìù Processing lab: $lab_name"
              
              # Create output directory for this lab
              mkdir -p "dist/$lab_name"
              
              # Enter lab directory to ensure relative image paths work correctly
              cd "$lab_dir"
              
              # ---------------------------------------------------------
              # MARKDOWN PREPROCESSING
              # Prepare markdown for conversion with enhanced features
              # ---------------------------------------------------------
              echo "  üîÑ Preprocessing markdown content..."
              cp "README.md" "${lab_name}_processed.md"
              
              # Use awk to wrap entire callout blocks in styled divs
              awk '
                BEGIN {
                  callout = 0;
                  callout_type = "";
                }
                # Detect start of callout block
                match($0, /^> \[!(NOTE|TIP|IMPORTANT|WARNING|CAUTION)\]/, m) {
                  callout = 1;
                  callout_type = tolower(m[1]);
                  # Map callout type to class and label
                  if (callout_type == "note") { class="note"; label="**Note:** "; }
                  else if (callout_type == "tip") { class="tip"; label="**Tip:** "; }
                  else { class="warning"; label="**" toupper(callout_type) ":** "; }
                  # Print opening div and first line
                  sub(/^> \[!(NOTE|TIP|IMPORTANT|WARNING|CAUTION)\]/, "> <div class=\"" class "\">" label);
                  print;
                  next;
                }
                # Continue callout block
                callout && /^> / {
                  print;
                  next;
                }
                # End of callout block
                callout && !/^> / {
                  print "</div>";
                  callout = 0;
                  callout_type = "";
                }
                # Print normal lines
                { print; }
              ' "${lab_name}_processed.md" > "${lab_name}_callouts.md"
              mv "${lab_name}_callouts.md" "${lab_name}_processed.md"
              
              # ---------------------------------------------------------
              # HEADER NORMALIZATION FOR CONSISTENT NAVIGATION
              # Remove emojis and special characters from headers for clean anchor links
              # ---------------------------------------------------------
              echo "  üßπ Cleaning headers for consistent navigation..."
              # Use perl for better Unicode emoji handling (supports all emojis, not just hardcoded list)
              # This regex matches any emoji/special character sequence at the start of a header
              # followed by optional spaces, then captures the actual text content
              perl -i -pe 's/^(#{2,4})\s*[^\w\s]+\s*([a-zA-Z].*)$/$1 $2/g' "${lab_name}_processed.md"
              
              # Fix internal anchor links to match cleaned headers
              # Remove emojis and special characters from anchor links (e.g., #üåê-introduction -> #-introduction)
              perl -i -pe 's/\(#[^\w\s-]+\s*-?\s*([a-z][^)]*)\)/(#$1)/g' "${lab_name}_processed.md"
              # Remove leading dashes from anchor links (e.g., #-introduction -> #introduction)
              sed -i 's|(#-\([a-zA-Z][^)]*\))|(#\1)|g' "${lab_name}_processed.md"
              
              # ---------------------------------------------------------
              # EXTRACT DOCUMENT TITLE FROM H1 HEADER
              # Use the actual lab title instead of directory name
              # ---------------------------------------------------------
              lab_title=$(grep -m 1 '^# ' "${lab_name}_processed.md" | sed 's/^# //' | sed 's/[*_`]//g' | head -1)
              if [ -z "$lab_title" ]; then
                lab_title="$lab_name - Microsoft Copilot Studio Labs"
              fi
              echo "  üìã Document title: $lab_title"
              
              # ---------------------------------------------------------
              # PANDOC CONVERSION: MARKDOWN ‚Üí HTML
              # Convert with professional styling and web optimization
              # ---------------------------------------------------------
              echo "  üîÑ Converting to HTML with Pandoc..."
              
              # Debug: Show processed markdown file stats for troubleshooting
              if [ -f "${lab_name}_processed.md" ]; then
                echo "  üìä Processed markdown stats: $(wc -l < "${lab_name}_processed.md") lines, $(wc -c < "${lab_name}_processed.md") bytes"
                
                # Debug: Show table count in processed file
                table_count=$(grep -c '^|.*|$' "${lab_name}_processed.md" || echo "0")
                echo "  üìã Table rows found: $table_count"
                
                # Debug: Show if horizontal rules are present
                hr_count=$(grep -c '^---$' "${lab_name}_processed.md" || echo "0")
                echo "  üìè Horizontal rules found: $hr_count"
                
                # For mbr-prep-sharepoint-agent specifically, show more details
                if [ "$lab_name" = "mbr-prep-sharepoint-agent" ]; then
                  echo "  üîç MBR Lab Debug - First 10 table-like lines:"
                  grep '^|' "${lab_name}_processed.md" | head -10 || echo "    No table rows found"
                fi
              else
                echo "  ‚ùå ERROR: Processed markdown file not found: ${lab_name}_processed.md"
                ls -la "${lab_name}"*
                continue
              fi
              
              # ---------------------------------------------------------
              # YAML PARSING CONFLICT DETECTION AND HANDLING
              # Detect files with horizontal rules that cause YAML parsing issues
              # ---------------------------------------------------------
              yaml_disabled_format="markdown+auto_identifiers+gfm_auto_identifiers+emoji+header_attributes"
              
              # Check if file has horizontal rules that aren't proper YAML front matter
              if grep -q '^---$' "${lab_name}_processed.md"; then
                first_line=$(head -1 "${lab_name}_processed.md")
                second_line=$(sed -n '2p' "${lab_name}_processed.md")
                
                # Disable YAML parsing if:
                # 1. First line is not "---" (horizontal rules in content)
                # 2. First line is "---" but second line is also "---" (empty YAML block)
                if [ "$first_line" != "---" ] || [ "$second_line" = "---" ]; then
                  echo "  ‚ö†Ô∏è  Detected horizontal rules in content or invalid YAML front matter - disabling YAML parsing"
                  yaml_disabled_format="markdown-yaml_metadata_block+auto_identifiers+gfm_auto_identifiers+emoji+header_attributes"
                fi
              fi
              
              # Try Pandoc conversion with detailed error output for debugging
              set +e  # Temporarily disable exit on error for better error handling
              pandoc_output=$(pandoc "${lab_name}_processed.md" \
                -o "../../dist/${lab_name}/${lab_name}.html" \
                --standalone \
                --self-contained \
                --css="../../.github/styles/html.css" \
                --html-q-tags \
                --section-divs \
                --id-prefix="" \
                --metadata title="$lab_title" \
                --metadata lang="en" \
                -f "$yaml_disabled_format" \
                -t html5 2>&1)
              
              pandoc_exit_code=$?
              set -e  # Re-enable exit on error
              
              if [ $pandoc_exit_code -eq 0 ] && [ -f "../../dist/${lab_name}/${lab_name}.html" ]; then
                echo "    ‚úÖ HTML conversion successful"
                
                # Debug: Check if HTML contains tables
                html_output_file="../../dist/${lab_name}/${lab_name}.html"
                table_tags=$(grep -c '<table' "$html_output_file" || echo "0")
                th_tags=$(grep -c '<th' "$html_output_file" || echo "0")
                td_tags=$(grep -c '<td' "$html_output_file" || echo "0")
                echo "  üìä HTML Debug - Tables: $table_tags, Headers: $th_tags, Cells: $td_tags"
                
                # For mbr-prep-sharepoint-agent specifically, show more details
                if [ "$lab_name" = "mbr-prep-sharepoint-agent" ]; then
                  echo "  üîç MBR Lab HTML Debug - Table structure:"
                  grep -E -A2 -B2 '<(table|th)|</table>' "$html_output_file" | head -15 || echo "    No table structure found"
                fi
                
                # ---------------------------------------------------------
                # HTML POST-PROCESSING AND CLEANUP
                # Clean up generated HTML for better web display
                # ---------------------------------------------------------
                echo "  üßπ Post-processing HTML for web optimization..."
                
                # Define path to generated HTML file
                html_output_file="../../dist/${lab_name}/${lab_name}.html"
                
                # Remove Pandoc's title block header (keep <title> in <head>)
                sed -i '/<header id="title-block-header">/,/<\/header>/d' "$html_output_file"
                
                # Clean up empty or malformed IDs that break navigation
                sed -i 's/id=""//g' "$html_output_file"
                sed -i 's/id="[[:space:]]*"//g' "$html_output_file"
                
                # Fix anchor link formatting from conversion artifacts
                sed -i 's/href="#[[:space:]]*\([^"[:space:]]*\)[[:space:]]*"/href="#\1"/g' "$html_output_file"
                
                # Headers use single id attribute approach (recommended by reviewer)
                # Pandoc already generates proper id attributes, no additional processing needed
                
                # Make external links open in new window
                # Add target="_blank" and rel="noopener noreferrer" to external links (http/https)
                # This regex matches links that start with http:// or https:// and adds the attributes
                sed -i 's/<a href="\(https\?:\/\/[^"]*\)"/<a href="\1" target="_blank" rel="noopener noreferrer"/g' "$html_output_file"
                
                # Add simple favicon for consistent branding (blue circle with L)
                sed -i 's|</head>|  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iIzJCNTc5QSIvPgogIDx0ZXh0IHg9IjUwIiB5PSI2NSIgZm9udC1mYW1pbHk9IkFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDUiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+TDwvdGV4dD4KPC9zdmc+">\n</head>|' "$html_output_file"
                
                echo "‚úì Successfully converted $lab_name to HTML with favicon"
              else
                # Main Pandoc conversion failed - show detailed error info
                echo "  ‚ùå PANDOC CONVERSION FAILED for $lab_name"
                echo "  üîç Exit code: $pandoc_exit_code"
                if [ -n "$pandoc_output" ]; then
                  echo "  üìù Pandoc error output:"
                  echo "$pandoc_output" | head -10
                fi
                
                # Try fallback conversion without CSS and complex options
                echo "  üîÑ Trying fallback HTML method for $lab_name..."
                set +e  # Disable exit on error for fallback
                fallback_output=$(pandoc "${lab_name}_processed.md" -o "../../dist/${lab_name}/${lab_name}.html" \
                  --standalone \
                  --section-divs \
                  --toc \
                  --id-prefix="" \
                  --metadata title="$lab_title" \
                  --metadata lang="en" \
                  -f markdown+auto_identifiers+gfm_auto_identifiers+emoji \
                  -t html5 2>&1)
                
                fallback_exit_code=$?
                set -e  # Re-enable exit on error
                
                if [ $fallback_exit_code -eq 0 ] && [ -f "../../dist/${lab_name}/${lab_name}.html" ]; then
                  echo "  ‚úÖ Fallback HTML conversion succeeded for $lab_name"
                  
                  # Remove the title block header for fallback conversion too
                  sed -i '/<header id="title-block-header">/,/<\/header>/d' "../../dist/${lab_name}/${lab_name}.html"
                else
                  echo "  ‚ùå FALLBACK ALSO FAILED for $lab_name"
                  echo "  üîç Fallback exit code: $fallback_exit_code"
                  if [ -n "$fallback_output" ]; then
                    echo "  üìù Fallback error output:"
                    echo "$fallback_output" | head -5
                  fi
                  
                  # Show some context about the processed file
                  echo "  üìÅ File debugging info:"
                  ls -la "${lab_name}"*
                  echo "  üî§ First 10 lines of processed markdown:"
                  head -10 "${lab_name}_processed.md" || echo "Could not read processed file"
                fi
              fi
              
              # Cleanup processed file
              rm -f "${lab_name}_processed.md"
              
              # Change back to root directory
              cd - > /dev/null
            fi
          done

          echo "Generated HTML count: $(find dist -name "*.html" -type f | wc -l 2>/dev/null || echo "0")"

      # =================================================================
      # STEP 4: HTML TO PDF CONVERSION
      # =================================================================
      # Convert styled HTML files to professional PDFs with:
      # - Table of Contents and bookmarks for navigation
      # - Internal links preserved for PDF navigation
      # - Page numbering and professional layout
      # =================================================================
      - name: üìÑ Generate Professional PDFs
        run: |
          echo "üìÑ Starting PDF generation for all labs..."
          
          # Process each lab directory with an HTML file in dist
          for lab_dir in labs/*/; do
            if [ -d "$lab_dir" ]; then
              lab_name=$(basename "$lab_dir")
              html_file="dist/${lab_name}/${lab_name}.html"
              
              if [ -f "$html_file" ]; then
                echo "üîÑ Processing: $lab_name"
                
                # Stay in root directory - don't change to lab directory
                # All paths are relative to repository root
                
                # Debug: Check HTML file before PDF conversion
                echo "Checking HTML structure for $lab_name:"
                echo "HTML file location: $html_file"
                
                # Check if title-block-header still exists (should be removed)
                if grep -q "title-block-header" "$html_file"; then
                  echo "‚ö†Ô∏è  WARNING: title-block-header still found in HTML before PDF conversion"
                  echo "Attempting to remove it now..."
                  sed -i '/<header id="title-block-header">/,/<\/header>/d' "$html_file"
                else
                  echo "‚úì No title-block-header found in HTML - clean for PDF conversion"
                fi
                
                # Optimize HTML for PDF bookmarks - ensure headers have proper structure
                echo "Optimizing HTML for PDF bookmarks..."
                
                # Ensure headers have clean id attributes for PDF navigation
                # Modern approach: single id attribute with scroll-margin CSS instead of duplicate anchors
                sed -i 's/<h\([1-6]\) id="\([^"]*\)"[^>]*>/<h\1 id="\2">/g' "$html_file"
                
                # Debug: Show what internal links are available for PDF navigation
                echo "Preserving internal links for PDF navigation..."
                internal_link_count=$(grep -o '<a href="#[^"]*"[^>]*>[^<]*</a>' "$html_file" | wc -l)
                if [ "$internal_link_count" -gt 0 ]; then
                  echo "Found $internal_link_count internal links to preserve in PDF:"
                  grep -o '<a href="#[^"]*"[^>]*>[^<]*</a>' "$html_file" | head -3
                else
                  echo "No HTML internal links found"
                fi
                
                echo "‚úì Internal links preserved for PDF navigation"
                
                # Convert HTML to PDF using Puppeteer with internal links preserved
                echo "Generating PDF with Puppeteer (preserving internal navigation)..."
                lab_title=$(grep -m 1 '<title>' "$html_file" | sed 's/<[^>]*>//g' | sed 's/^[ \t]*//;s/[ \t]*$//' || echo "$lab_name")
                pdf_output_file="dist/${lab_name}/${lab_name}.pdf"
                
                # Use absolute path from repository root
                if node ".github/scripts/generate-pdf.js" "$html_file" "$pdf_output_file" "$lab_title"; then
                  echo "‚úì Successfully converted $lab_name HTML to PDF with internal links"
                else
                  echo "‚úó Failed to convert $lab_name HTML to PDF with Puppeteer"
                  echo "  This might be due to internal link navigation issues in PDF generation"
                fi
              else
                echo "‚úó HTML file not found for $lab_name"
              fi
            fi
          done

          echo "Generated PDF count: $(find dist -name "*.pdf" -type f | wc -l 2>/dev/null || echo "0")"

      # =================================================================
      # STEP 5: GENERATE HOMEPAGE HTML
      # =================================================================
      # Convert root README.md to index.html for GitHub Pages deployment
      # This avoids duplicating Pandoc installation in the deploy workflow
      # =================================================================
      - name: üè† Generate Homepage HTML from Root README
        run: |
          echo "üè† Converting root README.md to homepage HTML..."
          
          # Use robust Node.js script to transform README links using Markdown AST
          echo "üîÑ Transforming homepage links using robust Markdown AST parser..."
          node .github/scripts/transform-homepage-links.js README.md dist/README_processed.md
          
          # Convert processed README to HTML with professional styling
          echo "üé® Converting Markdown to HTML with professional styling..."
          pandoc dist/README_processed.md \
            -o dist/index.html \
            --standalone \
            --embed-resources \
            --css=".github/styles/html.css" \
            --html-q-tags \
            --section-divs \
            --metadata title="Microsoft Copilot Studio Labs" \
            -f markdown+auto_identifiers+gfm_auto_identifiers+emoji \
            -t html5
          
          # Clean up temporary file
          rm dist/README_processed.md
          
          echo "‚úÖ Homepage generated successfully at dist/index.html"

      # =================================================================
      # STEP 6: UPLOAD GENERATED DOCUMENTS AS ARTIFACTS
      # =================================================================
      # Save generated HTML and PDF files as workflow artifacts
      # for the deployment workflow to consume
      # =================================================================
      - name: üì¶ Upload Generated Documents as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lab-documentation
          path: dist/
          retention-days: 30
          if-no-files-found: error

# =============================================================================
# END OF WORKFLOW: Generate Lab Documentation (HTML & PDF)
# =============================================================================
# This workflow successfully:
# ‚úÖ Converts all lab markdown files to professional HTML with styling
# ‚úÖ Generates PDF versions with TOC, bookmarks, and clean content
# ‚úÖ Handles internal links appropriately for each format
# ‚úÖ Uploads generated files as artifacts for deployment workflow
# ‚úÖ Triggers the deployment workflow for GitHub Pages
# =============================================================================
