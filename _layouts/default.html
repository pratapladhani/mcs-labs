<!DOCTYPE html>
<html
  lang="en"
  data-theme="{% if page.theme_mode %}{{ page.theme_mode }}{% else %}light{% endif %}"
  data-theme-family="{% if page.theme_family %}{{ page.theme_family }}{% else %}rich{% endif %}"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      {% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}
    </title>

    <!-- Prevent FOUC by hiding content until theme is ready -->
    <style>
      /* Hide body content until theme CSS is loaded */
      html:not(.theme-ready) body {
        visibility: hidden;
      }
      
      /* Prevent layout shift during theme loading */
      html:not(.theme-ready) body {
        opacity: 0;
      }
      
      /* Smooth transition when theme becomes ready */
      html.theme-ready body {
        visibility: visible;
        opacity: 1;
        transition: opacity 0.15s ease-in;
      }
    </style>

    <!-- Immediate theme script that runs before any rendering -->
    <script>
      // Set theme attributes and load correct CSS immediately from localStorage
      (function () {
        const savedTheme = localStorage.getItem("theme-family") || "rich";
        const savedMode = localStorage.getItem("theme-mode") || "light";
        const baseUrl = window.location.pathname.includes('/mcs-labs') ? '/mcs-labs' : '';

        // Override HTML attributes with localStorage values immediately
        document.documentElement.setAttribute("data-theme", savedMode);
        document.documentElement.setAttribute("data-theme-family", savedTheme);

        // Load only the active theme CSS synchronously
        const themePath = baseUrl + '/assets/css/themes/theme-' + savedTheme + '.css';
        document.write('<link rel="stylesheet" href="' + themePath + '" id="active-theme-css">');
        
        // Mark theme as ready after a brief moment to allow CSS to apply
        setTimeout(function() {
          document.documentElement.classList.add('theme-ready');
        }, 50);
      })();
    </script>

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ '/favicon.svg' | relative_url }}"
    />
    <link rel="apple-touch-icon" href="{{ '/favicon.svg' | relative_url }}" />

    <link
      rel="stylesheet"
      href="{{ '/assets/css/style.css' | relative_url }}"
    />

    {% seo %}
  </head>
  <body class="{% if page.layout == 'lab' %}lab-page{% endif %}">
    <header class="site-header">
      <div class="container">
        <div class="header-content">
          <h1><a href="{{ '/' | relative_url }}">{{ site.title }}</a></h1>
          <nav class="main-nav">
            <!-- NAVIGATION STRUCTURE:
                 Home: Main homepage with journey cards (excludes bootcamp and events)
                 All Labs: Complete lab listing page
                 Events: Dropdown menu containing all event/workshop pages
                 
                 WHY DROPDOWN NAVIGATION:
                 - Scalable: Supports unlimited future events without navigation crowding
                 - Clean: Keeps header uncluttered on all screen sizes
                 - Industry Standard: Users expect dropdowns for grouped content
                 - Mobile-Friendly: Touch interaction for tablets and phones
                 - Future-Proof: Adding new events requires only updating dropdown list
                 
                 ARCHITECTURE:
                 - Generic .events-dropdown-* CSS classes (not event-specific)
                 - Uses CSS custom properties for theme compatibility
                 - JavaScript handles toggle, outside clicks, keyboard (Escape)
                 - Accessible with ARIA attributes and keyboard navigation -->
            <a href="{{ '/' | relative_url }}">Home</a>
            <a href="{{ '/labs/' | relative_url }}">All Labs</a>
            
            <!-- Events Dropdown Menu -->
            <div class="events-dropdown-container">
              <button class="events-dropdown-btn" aria-expanded="false" aria-haspopup="true">
                Events
                <span class="dropdown-arrow" aria-hidden="true">‚ñæ</span>
              </button>
              <div class="events-dropdown-panel" aria-label="Events menu">
                <a href="{{ '/labs/bootcamp/' | relative_url }}" class="events-dropdown-item">
                  <span class="event-icon">‚öîÔ∏è</span>
                  <span class="event-text">Architecture Bootcamp</span>
                </a>
                <a href="{{ '/labs/azure-ai-workshop/' | relative_url }}" class="events-dropdown-item">
                  <span class="event-icon">‚òÅÔ∏è</span>
                  <span class="event-text">Azure AI Workshop</span>
                </a>
                <a href="{{ '/labs/mcs-in-a-day/' | relative_url }}" class="events-dropdown-item">
                  <span class="event-icon">‚ö°</span>
                  <span class="event-text">MCS in a Day</span>
                </a>
                <a href="{{ '/labs/agent-buildathon-1day/' | relative_url }}" class="events-dropdown-item">
                  <span class="event-icon">üèóÔ∏è</span>
                  <span class="event-text">Agent Build-A-Thon (1 day)</span>
                </a>
                <a href="{{ '/labs/agent-buildathon-1month/' | relative_url }}" class="events-dropdown-item">
                  <span class="event-icon">üöÄ</span>
                  <span class="event-text">Agent Build-A-Thon (1 month)</span>
                </a>
                <!-- ADD NEW EVENTS HERE:
                     Copy the structure above for each new event
                     Use appropriate icon and event name
                     No CSS changes needed - dropdown auto-sizes -->
              </div>
            </div>
          </nav>
          <div class="header-actions">
            <div class="theme-controls">
              <div class="theme-style-toggle">
                <button
                  class="theme-style-btn"
                  data-theme="rich"
                  aria-label="Rich theme style"
                >
                  <span class="theme-icon">üé®</span>
                  <span class="theme-label">Rich</span>
                </button>
                <button
                  class="theme-style-btn"
                  data-theme="minimal"
                  aria-label="Minimal theme style"
                >
                  <span class="theme-icon">üìÑ</span>
                  <span class="theme-label">Minimal</span>
                </button>
              </div>
              <div class="mode-divider"></div>
              <button
                class="light-dark-toggle"
                aria-label="Toggle light/dark mode"
                title="Toggle light/dark mode"
              >
                <span class="light-dark-icon">üåô</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="site-content">
      <div class="container">{{ content }}</div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>&copy; {{ 'now' | date: "%Y" }} Microsoft Copilot Studio Labs</p>
      </div>
    </footer>

    <!-- Load theme manager -->
    <script src="{{ '/assets/js/theme-manager.js' | relative_url }}"></script>

    <script>
      // Enhanced theme functionality with multiple theme support
      (function () {
        // Legacy theme object for backward compatibility
        const theme = {
          get: () => ThemeManager.getCurrentTheme(),
          set: (value) => {
            // Map old theme values to new theme IDs
            const themeMap = {
              light: "rich-light",
              dark: "rich-dark",
            };
            const themeId = themeMap[value] || value;
            ThemeManager.applyTheme(themeId);
          },
          toggle: () => ThemeManager.cycleTheme(),
        };

        // GitHub-Style Callouts Implementation for all pages
        function initializeCallouts() {
          // Find all blockquotes in the document (not just lab-body)
          const blockquotes = document.querySelectorAll("blockquote");

          blockquotes.forEach((blockquote) => {
            // Get the text content to check for callout pattern
            const textContent = blockquote.textContent.trim();

            // Check if this blockquote starts with a callout pattern
            const match = textContent.match(
              /^\[!(NOTE|TIP|IMPORTANT|WARNING|CAUTION)\]/i
            );
            if (!match) return;

            const calloutType = match[1].toLowerCase();

            // Get the content after the callout marker
            const contentAfterMarker = textContent
              .replace(/^\[!(NOTE|TIP|IMPORTANT|WARNING|CAUTION)\]\s*/i, "")
              .trim();

            // Create callout container
            const calloutDiv = document.createElement("div");
            calloutDiv.className = `callout callout-${calloutType}`;

            // Create title element
            const titleDiv = document.createElement("div");
            titleDiv.className = "callout-title";
            titleDiv.textContent = calloutType.toUpperCase();

            // Create content container
            const contentDiv = document.createElement("div");
            contentDiv.className = "callout-content";

            // Clone the original blockquote content but remove the callout marker
            const clonedBlockquote = blockquote.cloneNode(true);
            const firstP = clonedBlockquote.querySelector("p:first-child");

            if (firstP) {
              // Remove the callout marker from the first paragraph
              const firstPText = firstP.innerHTML;
              const cleanedText = firstPText.replace(
                /^\[!(NOTE|TIP|IMPORTANT|WARNING|CAUTION)\]\s*/i,
                ""
              );

              if (cleanedText.trim()) {
                firstP.innerHTML = cleanedText;
              } else {
                // If first paragraph only had the marker, remove it entirely
                firstP.remove();
              }
            }

            // Move all content from cloned blockquote to content div
            Array.from(clonedBlockquote.children).forEach((child) => {
              contentDiv.appendChild(child);
            });

            // Build final callout
            calloutDiv.appendChild(titleDiv);
            calloutDiv.appendChild(contentDiv);

            // Replace the original blockquote with the callout
            blockquote.parentNode.replaceChild(calloutDiv, blockquote);
          });
        }

        function updateThemeControls(themeInfo) {
          // Update theme style buttons
          const themeStyleBtns = document.querySelectorAll(".theme-style-btn");
          themeStyleBtns.forEach((btn) => {
            const btnTheme = btn.getAttribute("data-theme");
            if (btnTheme === themeInfo.family) {
              btn.classList.add("active");
            } else {
              btn.classList.remove("active");
            }
          });

          // Update light/dark toggle icon
          const icon = document.querySelector(".light-dark-icon");
          const button = document.querySelector(".light-dark-toggle");
          if (icon && themeInfo) {
            icon.textContent = themeInfo.mode === "light" ? "üåô" : "‚òÄÔ∏è";
            if (button) {
              const modeText = themeInfo.mode === "light" ? "dark" : "light";
              button.setAttribute("aria-label", `Switch to ${modeText} mode`);
              button.setAttribute("title", `Switch to ${modeText} mode`);
            }
          }
        }

        // Initialize theme system on page load (skip if already initialized)
        document.addEventListener("DOMContentLoaded", function () {
          // Check if ThemeManager is available
          if (typeof ThemeManager === "undefined") {
            console.error(
              "ThemeManager not found! Script may not have loaded."
            );
            return;
          }

          // ===================================================================
          // EVENTS DROPDOWN NAVIGATION
          // ===================================================================
          // Handles dropdown menu interaction for events navigation
          // 
          // FUNCTIONALITY:
          // - Toggle dropdown on button click
          // - Close dropdown when clicking outside
          // - Close dropdown on Escape key
          // - Close dropdown when navigating to an event
          // - Accessible with keyboard navigation (Tab, Enter, Escape)
          // 
          // WHY THIS APPROACH:
          // - Vanilla JavaScript (no dependencies)
          // - Minimal code (~40 lines)
          // - Works with all themes
          // - Mobile and desktop compatible
          // - Follows accessibility best practices
          // ===================================================================
          
          const dropdownBtn = document.querySelector('.events-dropdown-btn');
          const dropdownPanel = document.querySelector('.events-dropdown-panel');
          const dropdownContainer = document.querySelector('.events-dropdown-container');
          
          if (dropdownBtn && dropdownPanel) {
            // Toggle dropdown on button click
            dropdownBtn.addEventListener('click', function(e) {
              e.stopPropagation(); // Prevent immediate outside click
              const isOpen = dropdownPanel.classList.contains('show');
              
              if (isOpen) {
                dropdownPanel.classList.remove('show');
                dropdownBtn.setAttribute('aria-expanded', 'false');
              } else {
                dropdownPanel.classList.add('show');
                dropdownBtn.setAttribute('aria-expanded', 'true');
              }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
              if (!dropdownContainer.contains(e.target)) {
                dropdownPanel.classList.remove('show');
                dropdownBtn.setAttribute('aria-expanded', 'false');
              }
            });
            
            // Close dropdown on Escape key
            document.addEventListener('keydown', function(e) {
              if (e.key === 'Escape' && dropdownPanel.classList.contains('show')) {
                dropdownPanel.classList.remove('show');
                dropdownBtn.setAttribute('aria-expanded', 'false');
                dropdownBtn.focus(); // Return focus to button for accessibility
              }
            });
            
            // Close dropdown when clicking an event link
            const eventLinks = dropdownPanel.querySelectorAll('.events-dropdown-item');
            eventLinks.forEach(function(link) {
              link.addEventListener('click', function() {
                dropdownPanel.classList.remove('show');
                dropdownBtn.setAttribute('aria-expanded', 'false');
              });
            });
          }

          // Only initialize if not already done in head
          if (!window._themeInitialized) {
            ThemeManager.init();
          } else {
            // Sync ThemeManager state with already applied theme
            const currentFamily =
              document.documentElement.getAttribute("data-theme-family") ||
              "rich";
            const currentMode =
              document.documentElement.getAttribute("data-theme") || "light";
            // Update ThemeManager internal state without re-applying
            ThemeManager.syncState(currentFamily, currentMode);
          }

          // Initialize GitHub-style callouts for all pages
          initializeCallouts();

          // Update theme controls with current theme
          updateThemeControls(ThemeManager.getCurrentThemeInfo());

          // Add event listeners to theme style buttons
          const themeStyleBtns = document.querySelectorAll(".theme-style-btn");
          const lightDarkToggle = document.querySelector(".light-dark-toggle");

          themeStyleBtns.forEach((btn) => {
            btn.addEventListener("click", function (e) {
              const selectedTheme = e.currentTarget.getAttribute("data-theme");
              ThemeManager.changeThemeFamily(selectedTheme);
            });
          });

          if (lightDarkToggle) {
            lightDarkToggle.addEventListener("click", function (e) {
              e.preventDefault();
              ThemeManager.toggleMode();
            });
          } else {
            console.error("Light/dark toggle not found!");
          }

          // Listen for theme changes
          window.addEventListener("themeChanged", function (e) {
            updateThemeControls(ThemeManager.getCurrentThemeInfo());
          });
        });

        // Listen for system theme changes
        window
          .matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", (e) => {
            if (!localStorage.getItem("theme")) {
              ThemeManager.applyTheme(e.matches ? "rich-dark" : "rich-light");
            }
          });

        // Make theme object globally available for backward compatibility
        window.theme = theme;
      })();

      // Make external links open in new tab
      document.addEventListener("DOMContentLoaded", function () {
        const links = document.querySelectorAll("a[href]");
        const currentDomain = window.location.hostname;

        links.forEach(function (link) {
          const href = link.getAttribute("href");

          // Check if it's an external link (starts with http/https and not current domain)
          if (
            href &&
            (href.startsWith("http://") || href.startsWith("https://"))
          ) {
            try {
              const linkDomain = new URL(href).hostname;

              // If it's external (different domain), add target="_blank" and security attributes
              if (
                linkDomain !== currentDomain &&
                linkDomain !== "pratapladhani.github.io"
              ) {
                link.setAttribute("target", "_blank");
                link.setAttribute("rel", "noopener noreferrer");

                // Add visual indicator for external links if not already present
                if (!link.querySelector(".external-link-icon")) {
                  const icon = document.createElement("span");
                  icon.className = "external-link-icon";
                  icon.innerHTML = " ‚Üó";
                  icon.style.cssText =
                    "font-size: 0.8em; opacity: 0.7; margin-left: 2px;";
                  link.appendChild(icon);
                }
              }
            } catch (e) {
              // Invalid URL, skip
              console.debug("Invalid URL:", href);
            }
          }
        });
      });
    </script>

    <!-- 
      Jekyll Rouge Syntax Highlighting
      =================================
      Syntax highlighting is handled server-side by Jekyll's Rouge highlighter.
      Rouge generates HTML with semantic class names (e.g., .kd for keywords, .nx for names).
      The styling for these classes is defined in assets/css/style.css with light/dark theme support.
    -->
    
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
      
      // Initialize Mermaid with dynamic theme support
      // Automatically detects current theme (light/dark) and configures colors accordingly
      function initializeMermaid() {
        const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
        const theme = isDarkMode ? 'dark' : 'default';
        
        // Convert code blocks with language-mermaid to mermaid divs for rendering
        document.querySelectorAll('pre > code.language-mermaid').forEach(code => {
          const pre = code.closest('pre');
          if (pre) {
            const div = document.createElement('div');
            div.className = 'mermaid';
            div.innerHTML = code.innerHTML; // Use innerHTML to preserve <br/> tags
            pre.parentNode.replaceChild(div, pre);
          }
        });
        
        mermaid.initialize({
          startOnLoad: true,
          theme: theme,
          securityLevel: 'loose', // Allows full Mermaid feature set including click events
          themeVariables: {
            // Custom color palette that adapts to light/dark modes
            // These values provide good contrast and readability in both themes
            primaryColor: isDarkMode ? '#2b6cb0' : '#3182ce',
            primaryTextColor: isDarkMode ? '#ffffff' : '#1a202c',
            primaryBorderColor: isDarkMode ? '#4299e1' : '#2c5282',
            lineColor: isDarkMode ? '#a0aec0' : '#4a5568',
            secondaryColor: isDarkMode ? '#2d3748' : '#edf2f7',
            tertiaryColor: isDarkMode ? '#1a202c' : '#f7fafc',
            background: isDarkMode ? '#1a202c' : '#ffffff',
            mainBkg: isDarkMode ? '#2d3748' : '#ffffff',
            secondBkg: isDarkMode ? '#1a202c' : '#edf2f7',
            labelBackground: isDarkMode ? '#2d3748' : '#edf2f7',
            labelTextColor: isDarkMode ? '#ffffff' : '#1a202c',
            edgeLabelBackground: isDarkMode ? '#2d3748' : '#ffffff',
            noteTextColor: isDarkMode ? '#ffffff' : '#1a202c',
            noteBkgColor: isDarkMode ? '#3d4852' : '#fef5e7',
            noteBorderColor: isDarkMode ? '#4299e1' : '#f39c12',
            actorBkg: isDarkMode ? '#2b6cb0' : '#3182ce',
            actorBorder: isDarkMode ? '#4299e1' : '#2c5282',
            actorTextColor: isDarkMode ? '#ffffff' : '#ffffff',
            actorLineColor: isDarkMode ? '#a0aec0' : '#4a5568',
            signalColor: isDarkMode ? '#ffffff' : '#1a202c',
            signalTextColor: isDarkMode ? '#ffffff' : '#1a202c',
            sequenceNumberColor: isDarkMode ? '#ffffff' : '#ffffff'
          }
        });
      }
      
      // Initialize diagrams on page load
      initializeMermaid();
      
      // Listen for theme changes and re-render all diagrams with new colors
      // The 'themechange' event is fired by theme-manager.js when user switches themes
      window.addEventListener('themechange', () => {
        initializeMermaid();
        
        // Re-render all mermaid diagrams with updated theme
        // We store the original code to allow clean re-rendering
        document.querySelectorAll('.mermaid').forEach((element) => {
          const code = element.getAttribute('data-original-code') || element.textContent;
          element.setAttribute('data-original-code', code);
          element.removeAttribute('data-processed'); // Clear Mermaid's processed flag
          element.innerHTML = code; // Reset to original code
        });
        mermaid.run(); // Re-process all diagrams
      });
      
      // Store original diagram code on page load for theme switching
      // This preserves the source code before Mermaid transforms it into SVG
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.mermaid').forEach((element) => {
          const code = element.textContent;
          element.setAttribute('data-original-code', code);
        });
      });
    </script>
  </body>
</html>
